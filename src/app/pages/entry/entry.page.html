<div class="entry-page">
  <ion-header class="entry-header">
    <ion-toolbar>
      <ion-title>Registrar Jornada Laboral</ion-title>
      <div class="theme-toggle" slot="end">
        <ion-icon name="moon-outline" aria-hidden="true"></ion-icon>
        <ion-toggle
          [checked]="isDarkMode()"
          color="secondary"
          (ionChange)="onDarkModeChange($event.detail.checked)"
          aria-label="Cambiar modo oscuro"
        ></ion-toggle>
        <ion-icon name="sunny-outline" aria-hidden="true"></ion-icon>
      </div>
    </ion-toolbar>
  </ion-header>

  <ion-content [fullscreen]="true">
    <div class="entry-shell">
      <section class="entry-card">
        <div class="entry-card-header">
          <h1>Nueva Sesion</h1>
          <ion-button fill="clear" class="new-session" (click)="startNewSession()">
            <ion-icon slot="start" name="add-circle-outline" aria-hidden="true"></ion-icon>
            Nueva Sesion
          </ion-button>
        </div>

        <form [formGroup]="form" (submit)="saveSession(); $event.preventDefault()" class="entry-form">
          <ion-item lines="none" class="field-item">
            <ion-label position="stacked">Fecha y Hora de Inicio</ion-label>
            <ion-input type="datetime-local" formControlName="start"></ion-input>
            <ion-icon slot="end" name="calendar-outline" aria-hidden="true"></ion-icon>
          </ion-item>
          @if (isControlInvalid('start')) {
          <ion-note color="danger">Ingresa una fecha y hora de inicio valida.</ion-note>
          }

          <ion-item lines="none" class="field-item">
            <ion-label position="stacked">Fecha y Hora de Fin</ion-label>
            <ion-input type="datetime-local" formControlName="end"></ion-input>
            <ion-icon slot="end" name="calendar-outline" aria-hidden="true"></ion-icon>
          </ion-item>
          @if (isControlInvalid('end')) {
          <ion-note color="danger">Ingresa una fecha y hora de fin valida.</ion-note>
          }

          <ion-item lines="none" class="field-item">
            <ion-label position="stacked">Tarifa por Hora ($/hr)</ion-label>
            <ion-input type="number" min="0" step="0.01" formControlName="hourlyRate"></ion-input>
          </ion-item>
          @if (isControlInvalid('hourlyRate')) {
          <ion-note color="danger">La tarifa por hora debe ser numerica y positiva.</ion-note>
          }

          @if (form.errors?.['range']) {
          <ion-note color="danger">La hora de fin debe ser mayor o igual a la hora de inicio.</ion-note>
          }

          <article class="summary-box" role="status" aria-live="polite">
            <p>Horas Calculadas: {{ formatHours(durationPreview()) }}</p>
            <p>Ganancias Estimadas: {{ formatCurrency(estimatedIncome()) }}</p>
          </article>

          @if (lastSessionHours() !== null && lastSessionIncome() !== null) {
          <article class="last-saved" aria-live="polite">
            <p>Ultima sesion guardada</p>
            <span>{{ formatHours(lastSessionHours()) }} - {{ formatCurrency(lastSessionIncome()) }}</span>
          </article>
          }

          @if (errorMessage()) {
          <ion-text color="danger" class="error-message">{{ errorMessage() }}</ion-text>
          }

          <ion-button type="submit" expand="block" class="save-button" [disabled]="saving()">
            {{ saving() ? 'Guardando...' : 'Guardar Sesion' }}
          </ion-button>
        </form>
      </section>
    </div>
  </ion-content>

  <ion-toast
    [isOpen]="toastOpen()"
    [message]="toastMessage()"
    [duration]="2200"
    position="bottom"
    color="secondary"
    (didDismiss)="toastOpen.set(false)"
    aria-live="polite"
  ></ion-toast>
</div>
