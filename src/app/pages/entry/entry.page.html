<ion-header class="entry-header">
  <ion-toolbar>
    <ion-title>Registrar Jornada Laboral</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <main class="entry-shell">
    <section class="entry-card" aria-label="Formulario de registro de jornada">
      <div class="entry-card-header">
        <div class="entry-title-block">
          <h1 [class.user-title]="hasUserName()">{{ greetingTitle() }}</h1>
          <p class="active-work-center">Centro activo: {{ activeWorkCenterName() }}</p>
        </div>
        <button type="button" class="new-session" (click)="startNewSession()">
          <ion-icon name="add-circle-outline" aria-hidden="true"></ion-icon>
          <span>Nueva sesión</span>
        </button>
      </div>

      <form [formGroup]="form" class="entry-form">
        <div class="field-group">
          <label for="start-picker-button">Fecha y Hora de Inicio</label>
          <button
            id="start-picker-button"
            type="button"
            class="field-item field-picker"
            [class.field-error]="isControlInvalid('start')"
            (click)="openDateModal('start')"
          >
            <span class="field-picker-label">{{ dateButtonLabel('start') }}</span>
            <ion-icon name="calendar-outline" aria-hidden="true"></ion-icon>
          </button>
        </div>
        @if (isControlInvalid('start')) {
        <p class="error-note">Ingresa una fecha y hora de inicio válida.</p>
        }

        <div class="field-group">
          <label for="end-picker-button">Fecha y Hora de Fin</label>
          <button
            id="end-picker-button"
            type="button"
            class="field-item field-picker"
            [class.field-error]="isControlInvalid('end')"
            (click)="openDateModal('end')"
          >
            <span class="field-picker-label">{{ dateButtonLabel('end') }}</span>
            <ion-icon name="calendar-outline" aria-hidden="true"></ion-icon>
          </button>
        </div>
        @if (isControlInvalid('end')) {
        <p class="error-note">Ingresa una fecha y hora de salida válida.</p>
        }

        <div class="field-group">
          <label for="hourly-rate-input">Tarifa por Hora ($/hr)</label>
          <div class="field-item" [class.field-error]="isControlInvalid('hourlyRate')">
            <input
              id="hourly-rate-input"
              type="number"
              min="0"
              step="0.01"
              formControlName="hourlyRate"
            />
          </div>
        </div>
        @if (isControlInvalid('hourlyRate')) {
        <p class="error-note">La tarifa por hora debe ser numerica y positiva.</p>
        }

        @if (form.errors?.['range']) {
        <p class="error-note">La fecha y hora de salida debe ser posterior a la de entrada.</p>
        }

        <article class="summary-box" role="status" aria-live="polite">
          <p>Horas Calculadas: {{ formatHours(durationPreview()) }}</p>
          <p>Ganancias Estimadas: {{ formatCurrency(estimatedIncome()) }}</p>
        </article>

        @if (lastSessionHours() !== null && lastSessionIncome() !== null) {
        <article class="last-saved" aria-live="polite">
          <p>Última sesión guardada</p>
          <span>{{ formatHours(lastSessionHours()) }} - {{ formatCurrency(lastSessionIncome()) }}</span>
        </article>
        }

        @if (errorMessage()) {
        <p class="error-message">{{ errorMessage() }}</p>
        }

        <button type="button" class="save-button" [disabled]="saving()" (click)="saveSession()">
          {{ saving() ? 'Guardando...' : 'Guardar sesión' }}
        </button>
      </form>
    </section>
  </main>
</ion-content>

<ion-modal
  cssClass="entry-datetime-modal"
  [isOpen]="startModalOpen()"
  [keepContentsMounted]="true"
  (didDismiss)="closeDateModal('start')"
>
  <ng-template>
    <ion-header class="picker-header">
      <ion-toolbar>
        <ion-title>Inicio de jornada</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <ion-datetime
        id="start-datetime"
        presentation="date-time"
        locale="es-ES"
        hourCycle="h12"
        [showDefaultTimeLabel]="false"
        [value]="draftStartIso()"
        (ionChange)="onDateSelection('start', $event.detail.value)"
      >
        <span slot="time-label" class="picker-time-slot">Hora entrada</span>
      </ion-datetime>

      <div class="picker-actions">
        <button type="button" class="picker-cancel" (click)="closeDateModal('start')">Cancelar</button>
        <button type="button" class="picker-apply" (click)="applyDateSelection('start')">Aplicar</button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal
  cssClass="entry-datetime-modal"
  [isOpen]="endModalOpen()"
  [keepContentsMounted]="true"
  (didDismiss)="closeDateModal('end')"
>
  <ng-template>
    <ion-header class="picker-header">
      <ion-toolbar>
        <ion-title>Fin de jornada</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <ion-datetime
        id="end-datetime"
        presentation="date-time"
        locale="es-ES"
        hourCycle="h12"
        [showDefaultTimeLabel]="false"
        [value]="draftEndIso()"
        (ionChange)="onDateSelection('end', $event.detail.value)"
      >
        <span slot="time-label" class="picker-time-slot">Hora salida</span>
      </ion-datetime>

      <div class="picker-actions">
        <button type="button" class="picker-cancel" (click)="closeDateModal('end')">Cancelar</button>
        <button type="button" class="picker-apply" (click)="applyDateSelection('end')">Aplicar</button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-toast
  [isOpen]="toastOpen()"
  [message]="toastMessage()"
  [duration]="2200"
  position="bottom"
  color="secondary"
  (didDismiss)="toastOpen.set(false)"
  aria-live="polite"
></ion-toast>
