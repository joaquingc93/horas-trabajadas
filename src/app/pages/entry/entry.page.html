<ion-header class="entry-header">
  <ion-toolbar>
    <ion-title>Registrar Jornada Laboral</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <main class="entry-shell">
    <section class="entry-card" aria-label="Formulario de registro de jornada">
      <div class="entry-card-header">
        <h1>Nueva Sesion</h1>
        <button type="button" class="new-session" (click)="startNewSession()">
          <ion-icon name="add-circle-outline" aria-hidden="true"></ion-icon>
          <span>Nueva Sesion</span>
        </button>
      </div>

      <form [formGroup]="form" class="entry-form">
        <div class="field-group">
          <label for="start-input">Fecha y Hora de Inicio</label>
          <div class="field-item" [class.field-error]="isControlInvalid('start')">
            <input id="start-input" type="datetime-local" formControlName="start" />
            <ion-icon name="calendar-outline" aria-hidden="true"></ion-icon>
          </div>
        </div>
        @if (isControlInvalid('start')) {
        <p class="error-note">Ingresa una fecha y hora de inicio valida.</p>
        }

        <div class="field-group">
          <label for="end-input">Fecha y Hora de Fin</label>
          <div class="field-item" [class.field-error]="isControlInvalid('end')">
            <input id="end-input" type="datetime-local" formControlName="end" />
            <ion-icon name="calendar-outline" aria-hidden="true"></ion-icon>
          </div>
        </div>
        @if (isControlInvalid('end')) {
        <p class="error-note">Ingresa una fecha y hora de fin valida.</p>
        }

        <div class="field-group">
          <label for="hourly-rate-input">Tarifa por Hora ($/hr)</label>
          <div class="field-item" [class.field-error]="isControlInvalid('hourlyRate')">
            <input
              id="hourly-rate-input"
              type="number"
              min="0"
              step="0.01"
              formControlName="hourlyRate"
            />
          </div>
        </div>
        @if (isControlInvalid('hourlyRate')) {
        <p class="error-note">La tarifa por hora debe ser numerica y positiva.</p>
        }

        @if (form.errors?.['range']) {
        <p class="error-note">La hora de fin debe ser mayor o igual a la hora de inicio.</p>
        }

        <article class="summary-box" role="status" aria-live="polite">
          <p>Horas Calculadas: {{ formatHours(durationPreview()) }}</p>
          <p>Ganancias Estimadas: {{ formatCurrency(estimatedIncome()) }}</p>
        </article>

        @if (lastSessionHours() !== null && lastSessionIncome() !== null) {
        <article class="last-saved" aria-live="polite">
          <p>Ultima sesion guardada</p>
          <span>{{ formatHours(lastSessionHours()) }} - {{ formatCurrency(lastSessionIncome()) }}</span>
        </article>
        }

        @if (errorMessage()) {
        <p class="error-message">{{ errorMessage() }}</p>
        }

        <button type="button" class="save-button" [disabled]="saving()" (click)="saveSession()">
          {{ saving() ? 'Guardando...' : 'Guardar Sesion' }}
        </button>
      </form>
    </section>
  </main>
</ion-content>

<ion-toast
  [isOpen]="toastOpen()"
  [message]="toastMessage()"
  [duration]="2200"
  position="bottom"
  color="secondary"
  (didDismiss)="toastOpen.set(false)"
  aria-live="polite"
></ion-toast>
