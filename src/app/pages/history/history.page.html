<ion-header class="history-header">
  <ion-toolbar>
    <ion-title>Historial de jornadas</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <main class="history-shell">
      <section class="filters-grid">
        <div class="filter-field">
          <label for="history-filter-from">Desde</label>
          <div class="filter-input-wrap">
            <input
              id="history-filter-from"
              type="date"
              [value]="filterFrom()"
              (input)="onFilterInput('from', $event)"
            />
            <ion-icon name="calendar-outline" aria-hidden="true"></ion-icon>
          </div>
        </div>

        <div class="filter-field">
          <label for="history-filter-to">Hasta</label>
          <div class="filter-input-wrap">
            <input
              id="history-filter-to"
              type="date"
              [value]="filterTo()"
              (input)="onFilterInput('to', $event)"
            />
            <ion-icon name="calendar-outline" aria-hidden="true"></ion-icon>
          </div>
        </div>
      </section>

      <section class="summary-grid">
        <article class="summary-card">
          <ion-icon name="time-outline" aria-hidden="true"></ion-icon>
          <div>
            <p>Total Horas</p>
            <strong>{{ totalHours().toFixed(2) }}h</strong>
          </div>
        </article>

        <article class="summary-card">
          <ion-icon name="cash-outline" aria-hidden="true"></ion-icon>
          <div>
            <p>Ganancias</p>
            <strong>{{ formatCurrency(totalIncome()) }}</strong>
          </div>
        </article>
      </section>

      <section class="actions-grid">
        <button type="button" class="action-button" [disabled]="!hasSessions() || exportingPdf()" (click)="exportPdf()">
          <ion-icon name="document-text-outline" aria-hidden="true"></ion-icon>
          {{ exportingPdf() ? 'Exportando PDF...' : 'Exportar PDF' }}
        </button>

        <button
          type="button"
          class="action-button"
          [disabled]="!hasSessions() || exportingExcel()"
          (click)="exportExcel()"
        >
          <ion-icon name="list-outline" aria-hidden="true"></ion-icon>
          {{ exportingExcel() ? 'Exportando Excel...' : 'Exportar Excel' }}
        </button>
      </section>

      @if (actionMessage()) {
      <p class="action-message" aria-live="polite">{{ actionMessage() }}</p>
      }

      @if (hasSessions()) {
      <section class="sessions-list">
        @for (session of filteredSessions(); track trackById($index, session)) {
        <article class="session-item">
          <div class="session-date-col">
            <strong>{{ formatDateLabel(session.startIso) }}</strong>
            <span>{{ formatWeekDay(session.startIso) }}</span>
          </div>

          <div class="session-main-col">
            <p>{{ formatTimeRange(session) }}</p>
            <span>{{ formatCurrency(session.hourlyRate) }}/hr</span>
          </div>

          <div class="session-side-col">
            <strong>{{ formatHours(session.durationHours) }}</strong>
            <span>{{ formatCurrency(session.totalIncome) }}</span>

            <div class="session-actions-col">
              <button
                type="button"
                class="edit-button"
                (click)="openEditModal(session)"
                aria-label="Editar sesion"
              >
                <ion-icon name="create-outline" aria-hidden="true"></ion-icon>
              </button>
              <button
                type="button"
                class="delete-button"
                [disabled]="deletingId() === session.id"
                (click)="deleteSession(session.id)"
                aria-label="Eliminar sesion"
              >
                <ion-icon name="trash-outline" aria-hidden="true"></ion-icon>
              </button>
            </div>
          </div>
        </article>
        }
      </section>
      } @else {
      <section class="empty-state">
        <ion-icon name="list-outline" aria-hidden="true"></ion-icon>
        <p>No hay registros en el rango seleccionado.</p>
      </section>
      }
  </main>
</ion-content>

<ion-modal [isOpen]="editModalOpen()" (didDismiss)="closeEditModal()">
  <ng-template>
    <ion-header class="edit-header">
      <ion-toolbar>
        <ion-title>Editar sesion</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <form class="edit-form" [formGroup]="editForm">
        <div class="edit-field">
          <label for="edit-start">Fecha y hora de inicio</label>
          <input id="edit-start" formControlName="start" type="datetime-local" />
        </div>

        <div class="edit-field">
          <label for="edit-end">Fecha y hora de fin</label>
          <input id="edit-end" formControlName="end" type="datetime-local" />
        </div>

        <div class="edit-field">
          <label for="edit-rate">Tarifa por hora</label>
          <input id="edit-rate" formControlName="hourlyRate" type="number" min="0" step="0.01" />
        </div>

        <div class="edit-actions">
          <button type="button" class="edit-cancel" (click)="closeEditModal()">Cancelar</button>
          <button type="button" class="edit-save" [disabled]="savingEdit()" (click)="saveEdition()">
            {{ savingEdit() ? 'Guardando...' : 'Guardar cambios' }}
          </button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>
