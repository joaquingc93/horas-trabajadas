<ion-header class="history-header">
  <ion-toolbar>
    <ion-title>Historial de jornadas</ion-title>
  </ion-toolbar>
</ion-header>

<section class="history-fixed-zone">
  <section class="active-center-card" aria-label="Centro de trabajo activo">
    <p>Centro activo</p>
    <strong>{{ activeWorkCenterName() }}</strong>
  </section>

  <section class="filters-grid">
    <div class="filter-field">
      <label for="history-filter-from">Desde</label>
      <div class="filter-input-wrap">
        <button
          id="history-filter-from"
          type="button"
          class="filter-picker-button"
          aria-label="Abrir filtro desde fecha y hora"
          (click)="openFilterModal('from')"
        >
          <span class="filter-picker-value">{{ filterButtonLabel('from') }}</span>
          <ion-icon class="filter-calendar-icon" name="calendar-outline" aria-hidden="true"></ion-icon>
        </button>
      </div>
    </div>

    <div class="filter-field">
      <label for="history-filter-to">Hasta</label>
      <div class="filter-input-wrap">
        <button
          id="history-filter-to"
          type="button"
          class="filter-picker-button"
          aria-label="Abrir filtro hasta fecha y hora"
          (click)="openFilterModal('to')"
        >
          <span class="filter-picker-value">{{ filterButtonLabel('to') }}</span>
          <ion-icon class="filter-calendar-icon" name="calendar-outline" aria-hidden="true"></ion-icon>
        </button>
      </div>
    </div>
  </section>

  <section class="summary-grid">
    <article class="summary-card">
      <ion-icon name="time-outline" aria-hidden="true"></ion-icon>
      <div>
        <p>Total Horas</p>
        <strong>{{ totalHours().toFixed(2) }}h</strong>
      </div>
    </article>

    <article class="summary-card">
      <ion-icon name="cash-outline" aria-hidden="true"></ion-icon>
      <div>
        <p>Ganancias</p>
        <strong>{{ formatCurrency(totalIncome()) }}</strong>
      </div>
    </article>
  </section>

  <section class="actions-grid">
    <button type="button" class="action-button" [disabled]="!hasSessions() || exportingPdf()" (click)="exportPdf()">
      <ion-icon name="document-text-outline" aria-hidden="true"></ion-icon>
      {{ exportingPdf() ? 'Exportando PDF...' : 'Exportar PDF' }}
    </button>

    <button
      type="button"
      class="action-button"
      [disabled]="!hasSessions() || exportingExcel()"
      (click)="exportExcel()"
    >
      <ion-icon name="list-outline" aria-hidden="true"></ion-icon>
      {{ exportingExcel() ? 'Exportando Excel...' : 'Exportar Excel' }}
    </button>
  </section>

  @if (actionMessage()) {
  <p class="action-message" aria-live="polite">{{ actionMessage() }}</p>
  }
</section>

<ion-content
  id="history-content"
  [fullscreen]="false"
  [scrollY]="true"
>
  <main class="history-shell">
      @if (hasSessions()) {
      <section class="sessions-list">
        @for (session of filteredSessions(); track trackById($index, session)) {
        <article class="session-item">
          <div class="session-date-col">
            <strong>{{ formatDateLabel(session.startIso) }}</strong>
            <span>{{ formatWeekDay(session.startIso) }}</span>
          </div>

          <div class="session-main-col">
            <p>{{ formatTimeRange(session) }}</p>
            <span>{{ formatCurrency(session.hourlyRate) }}/hr</span>
          </div>

          <div class="session-side-col">
            <strong>{{ formatHours(session.durationHours) }}</strong>
            <span>{{ formatCurrency(session.totalIncome) }}</span>

            <div class="session-actions-col">
              <button
                type="button"
                class="edit-button"
                (click)="openEditModal(session)"
                aria-label="Editar sesión"
              >
                <ion-icon name="create-outline" aria-hidden="true"></ion-icon>
              </button>
              <button
                type="button"
                class="delete-button"
                [disabled]="deletingId() === session.id"
                (click)="openDeleteModal(session)"
                aria-label="Eliminar sesión"
              >
                <ion-icon name="trash-outline" aria-hidden="true"></ion-icon>
              </button>
            </div>
          </div>
        </article>
        }
      </section>
      } @else {
      <section class="empty-state">
        <ion-icon name="list-outline" aria-hidden="true"></ion-icon>
        <p>No hay registros en el rango seleccionado.</p>
      </section>
      }
  </main>

</ion-content>

<ion-modal cssClass="history-edit-modal" [isOpen]="editModalOpen()" (didDismiss)="closeEditModal()">
  <ng-template>
    <ion-header class="edit-header">
      <ion-toolbar>
        <ion-title>Editar sesión</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <form class="edit-form" [formGroup]="editForm">
        <div class="edit-field">
          <label for="edit-start">Fecha y hora de inicio</label>
          <input id="edit-start" formControlName="start" type="datetime-local" />
        </div>

        <div class="edit-field">
          <label for="edit-end">Fecha y hora de fin</label>
          <input id="edit-end" formControlName="end" type="datetime-local" />
        </div>

        <div class="edit-field">
          <label for="edit-rate">Tarifa por hora</label>
          <input id="edit-rate" formControlName="hourlyRate" type="number" min="0" step="0.01" />
        </div>

        <div class="edit-actions">
          <button type="button" class="edit-cancel" (click)="closeEditModal()">Cancelar</button>
          <button type="button" class="edit-save" [disabled]="savingEdit()" (click)="saveEdition()">
            {{ savingEdit() ? 'Guardando...' : 'Guardar cambios' }}
          </button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal cssClass="history-filter-modal" [isOpen]="filterFromModalOpen()" (didDismiss)="closeFilterModal('from')">
  <ng-template>
    <ion-header class="filter-header">
      <ion-toolbar>
        <ion-title>Filtrar desde</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <ion-datetime
        id="history-filter-from-datetime"
        presentation="date-time"
        locale="es-ES"
        hourCycle="h12"
        [showDefaultTimeLabel]="false"
        [value]="filterFromDraft()"
        (ionChange)="onFilterDateSelection('from', $event.detail.value)"
      >
        <span slot="time-label" class="filter-time-slot">Hora desde</span>
      </ion-datetime>

      <div class="filter-modal-actions">
        <button type="button" class="filter-modal-clear" (click)="clearFilterDate('from')">Limpiar</button>
        <button type="button" class="filter-modal-cancel" (click)="closeFilterModal('from')">Cancelar</button>
        <button type="button" class="filter-modal-apply" (click)="applyFilterDate('from')">Aplicar</button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal cssClass="history-filter-modal" [isOpen]="filterToModalOpen()" (didDismiss)="closeFilterModal('to')">
  <ng-template>
    <ion-header class="filter-header">
      <ion-toolbar>
        <ion-title>Filtrar hasta</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <ion-datetime
        id="history-filter-to-datetime"
        presentation="date-time"
        locale="es-ES"
        hourCycle="h12"
        [showDefaultTimeLabel]="false"
        [value]="filterToDraft()"
        (ionChange)="onFilterDateSelection('to', $event.detail.value)"
      >
        <span slot="time-label" class="filter-time-slot">Hora hasta</span>
      </ion-datetime>

      <div class="filter-modal-actions">
        <button type="button" class="filter-modal-clear" (click)="clearFilterDate('to')">Limpiar</button>
        <button type="button" class="filter-modal-cancel" (click)="closeFilterModal('to')">Cancelar</button>
        <button type="button" class="filter-modal-apply" (click)="applyFilterDate('to')">Aplicar</button>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-modal cssClass="history-delete-modal" [isOpen]="deleteModalOpen()" (didDismiss)="closeDeleteModal()">
  <ng-template>
    <ion-header class="delete-header">
      <ion-toolbar>
        <ion-title>Eliminar sesión</ion-title>
      </ion-toolbar>
    </ion-header>

    <ion-content>
      <section class="delete-body">
        <p class="delete-message">¿Seguro que deseas eliminar esta sesión?</p>
        @if (pendingDeleteSession()) {
        <p class="delete-summary">{{ pendingDeleteLabel() }}</p>
        }
        <p class="delete-note">Esta acción no se puede deshacer.</p>

        <label class="delete-acknowledge" for="confirm-delete-session">
          <input
            id="confirm-delete-session"
            type="checkbox"
            [checked]="deleteAcknowledged()"
            [disabled]="deletingPendingSession()"
            (change)="onDeleteAcknowledgedChange($event)"
          />
          <span>Confirmo que deseo eliminar esta sesión.</span>
        </label>

        <div class="delete-actions">
          <button type="button" class="delete-cancel-action" [disabled]="deletingPendingSession()" (click)="closeDeleteModal()">
            Cancelar
          </button>
          <button type="button" class="delete-confirm-action" [disabled]="!canConfirmDelete()" (click)="confirmDeleteSession()">
            {{ deletingPendingSession() ? 'Eliminando...' : 'Eliminar' }}
          </button>
        </div>
      </section>
    </ion-content>
  </ng-template>
</ion-modal>
