<div class="history-page">
  <ion-header class="history-header">
    <ion-toolbar>
      <ion-title>Historial de jornadas</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-content [fullscreen]="true">
    <div class="history-shell">
      <section class="filters-grid">
        <ion-item lines="none" class="filter-field">
          <ion-label position="stacked">Desde</ion-label>
          <ion-input
            type="date"
            [value]="filterFrom()"
            (ionChange)="onFilterDateChange('from', $event.detail.value)"
          ></ion-input>
          <ion-icon slot="end" name="calendar-outline" aria-hidden="true"></ion-icon>
        </ion-item>

        <ion-item lines="none" class="filter-field">
          <ion-label position="stacked">Hasta</ion-label>
          <ion-input
            type="date"
            [value]="filterTo()"
            (ionChange)="onFilterDateChange('to', $event.detail.value)"
          ></ion-input>
          <ion-icon slot="end" name="calendar-outline" aria-hidden="true"></ion-icon>
        </ion-item>
      </section>

      <section class="summary-grid">
        <article class="summary-card">
          <ion-icon name="time-outline" aria-hidden="true"></ion-icon>
          <div>
            <p>Total Horas</p>
            <strong>{{ totalHours().toFixed(2) }}h</strong>
          </div>
        </article>

        <article class="summary-card">
          <ion-icon name="cash-outline" aria-hidden="true"></ion-icon>
          <div>
            <p>Ganancias</p>
            <strong>{{ formatCurrency(totalIncome()) }}</strong>
          </div>
        </article>
      </section>

      <section class="actions-grid">
        <ion-button class="action-button" [disabled]="!hasSessions() || exportingPdf()" (click)="exportPdf()">
          <ion-icon slot="start" name="document-text-outline" aria-hidden="true"></ion-icon>
          {{ exportingPdf() ? 'Exportando PDF...' : 'Exportar PDF' }}
        </ion-button>

        <ion-button
          class="action-button"
          [disabled]="!hasSessions() || exportingExcel()"
          (click)="exportExcel()"
        >
          <ion-icon slot="start" name="list-outline" aria-hidden="true"></ion-icon>
          {{ exportingExcel() ? 'Exportando Excel...' : 'Exportar Excel' }}
        </ion-button>
      </section>

      @if (actionMessage()) {
      <ion-text class="action-message" aria-live="polite">{{ actionMessage() }}</ion-text>
      }

      @if (hasSessions()) {
      <ion-list class="sessions-list">
        @for (session of filteredSessions(); track trackById($index, session)) {
        <ion-item lines="none" class="session-item">
          <div class="session-date-col">
            <strong>{{ formatDateLabel(session.startIso) }}</strong>
            <span>{{ formatWeekDay(session.startIso) }}</span>
          </div>

          <div class="session-main-col">
            <p>{{ formatTimeRange(session) }}</p>
            <span>{{ formatCurrency(session.hourlyRate) }}/hr</span>
          </div>

          <div class="session-hours-col">
            <strong>{{ formatHours(session.durationHours) }}</strong>
            <span>{{ formatCurrency(session.totalIncome) }}</span>
          </div>

          <div class="session-actions-col">
            <ion-button fill="clear" size="small" class="edit-button" (click)="openEditModal(session)">
              <ion-icon name="create-outline" aria-hidden="true"></ion-icon>
            </ion-button>
            <ion-button
              fill="clear"
              size="small"
              class="delete-button"
              [disabled]="deletingId() === session.id"
              (click)="deleteSession(session.id)"
            >
              <ion-icon name="trash-outline" aria-hidden="true"></ion-icon>
            </ion-button>
          </div>
        </ion-item>
        }
      </ion-list>
      } @else {
      <section class="empty-state">
        <ion-icon name="list-outline" aria-hidden="true"></ion-icon>
        <p>No hay registros en el rango seleccionado.</p>
      </section>
      }
    </div>
  </ion-content>

  <ion-modal [isOpen]="editModalOpen()" (didDismiss)="closeEditModal()">
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-title>Editar sesion</ion-title>
        </ion-toolbar>
      </ion-header>

      <ion-content>
        <form class="edit-form" [formGroup]="editForm" (submit)="saveEdition(); $event.preventDefault()">
          <ion-item lines="none">
            <ion-label position="stacked">Fecha y hora de inicio</ion-label>
            <ion-input formControlName="start" type="datetime-local"></ion-input>
          </ion-item>

          <ion-item lines="none">
            <ion-label position="stacked">Fecha y hora de fin</ion-label>
            <ion-input formControlName="end" type="datetime-local"></ion-input>
          </ion-item>

          <ion-item lines="none">
            <ion-label position="stacked">Tarifa por hora</ion-label>
            <ion-input formControlName="hourlyRate" type="number" min="0" step="0.01"></ion-input>
          </ion-item>

          <div class="edit-actions">
            <ion-button fill="clear" (click)="closeEditModal()" type="button">Cancelar</ion-button>
            <ion-button [disabled]="savingEdit()" type="submit">
              {{ savingEdit() ? 'Guardando...' : 'Guardar cambios' }}
            </ion-button>
          </div>
        </form>
      </ion-content>
    </ng-template>
  </ion-modal>
</div>
